<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Sesi√≥n 1.3 Programaci√≥n de red con python. UDP</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">figure {
padding: 1em;
margin: 2em auto;
box-shadow: 10px 10px 7px -5px rgba(0,0,0,0.51);
}
figcaption {
font-size: small;
font-weight: bold;
text-align: center;
margin: 1em;
color: #888;
}
.markdown-body .highlight pre, .markdown-body pre {
padding: 0pt !important;
border-radius: 3px;
}
div.sourceCode {
margin: 0pt;
padding: 0pt;
border-radius: 3px;
margin-bottom: 1em;
}
pre.sourceCode::before {
font-size: 1rem;
color: #fff;
display: block;
position: relative;
top: 0pt;
left: 0pt;
width: 100%;
background: #999;
padding: 0;
text-indent: 1em;
background: #ccc;
padding: 0;
border-top-left-radius: 3px;
border-top-right-radius: 3px;
margin-bottom: 1ex;
}
pre.console, pre.shell {
padding: .5em 1em !important;
}
.markdown-body pre code {
text-indent: 1em;
}
pre.sourceCode.html::before{
content: "HTML";
}
pre.sourceCode.css::before{
content: "CSS";
}
pre.sourceCode.xml::before{
content: "XML";
}
pre.sourceCode.json::before{
content: "JSON";
}
pre.sourceCode.nginx::before{
content: "Nginx config";
}
pre.sourceCode.javascript::before{
content: "Javascript";
background-color: steelblue;
}
pre.sourceCode.text::before{
content: "";
}
pre.sourceCode.yaml::before{
content: "Yaml";
}
pre.sourceCode.sql::before{
content: "SQL";
}
pre.sourceCode.rust::before{
content: "Pseudoc√≥digo";
background-color: #f3e2bb;
color: #c09022;
}
pre.sourceCode.c\+\+::before{
content: "XDR";
background-color: #f3e2bb;
color: #c09022;
}
pre.sourceCode.python::before{
content: "Python";
background-color: #f3e2bb;
color: #c09022;
}
pre.sourceCode.java::before{
content: "Java";
background-color: #f3e2bb;
color: #c09022;
}
pre.sourceCode.C::before{
content: "C";
}
pre.sourceCode.dockerfile::before{
content: "Dockerfile";
}
pre.sourceCode.Makefile::before{
content: "Makefile";
background-color: #d0d0e0;
color: #888;
}
pre.sourceCode.bash::before{
content: "Shell";
background-color: #888;
}
code.sourceCode > span {
display: inline-block;
line-height: 1.4;
min-height: 1.4em;
}
.markdown-body {
-ms-text-size-adjust: 100%;
-webkit-text-size-adjust: 100%;
color: #24292e;
font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 16px;
line-height: 1.5;
word-wrap: break-word;
box-sizing: border-box;
min-width: 200px;
max-width: 110ex;
margin: 0 auto;
padding: 45px;
text-align: justify;
}
.markdown-body a {
color: #0366d6;
background-color: transparent;
text-decoration: none;
-webkit-text-decoration-skip: objects
}
.markdown-body a:active,
.markdown-body a:hover {
outline-width: 0
}
.markdown-body a:hover {
text-decoration: underline
}
.markdown-body a:not([href]) {
color: inherit;
text-decoration: none
}
.markdown-body strong {
font-weight: 600
}
.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
margin-top: 24px;
margin-bottom: 16px;
font-weight: 600;
line-height: 1.25
}
.markdown-body h1 {
font-size: 2em;
margin: .67em 0;
padding-bottom: .3em;
border-bottom: 1px solid #eaecef
}
.markdown-body h2 {
padding-bottom: .3em;
font-size: 1.5em;
border-bottom: 1px solid #eaecef
}
.markdown-body h3 {
font-size: 1.25em
}
.markdown-body h4 {
font-size: 1em
}
.markdown-body h5 {
font-size: .875em
}
.markdown-body h6 {
font-size: .85em;
color: #6a737d
}
.markdown-body img {
border-style: none
}
.markdown-body svg:not(:root) {
overflow: hidden
}
.markdown-body hr {
box-sizing: content-box;
height: .25em;
margin: 24px 0;
padding: 0;
overflow: hidden;
background-color: #e1e4e8;
border: 0
}
.markdown-body hr::before {
display: table;
content: ""
}
.markdown-body hr::after {
display: table;
clear: both;
content: ""
}
.markdown-body input {
margin: 0;
overflow: visible;
font: inherit;
font-family: inherit;
font-size: inherit;
line-height: inherit
}
.markdown-body [type=checkbox] {
box-sizing: border-box;
padding: 0
}
.markdown-body * {
box-sizing: border-box
}
.markdown-body blockquote {
margin: 0
}
.markdown-body ol,
.markdown-body ul {
padding-left: 2em
}
.markdown-body ol ol {
list-style-type: lower-roman
}
.markdown-body ol ol,
.markdown-body ol ul,
.markdown-body ul ol,
.markdown-body ul ul {
margin-top: 0;
margin-bottom: 0
}
.markdown-body ol ol ol,
.markdown-body ol ul ol,
.markdown-body ul ol ol,
.markdown-body ul ul ol {
list-style-type: lower-alpha
}
.markdown-body li>p {
margin-top: 16px
}
.markdown-body li+li {
margin-top: .25em
}
.markdown-body dd {
margin-left: 0
}
.markdown-body dl {
padding: 0
}
.markdown-body dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: 600
}
.markdown-body dl dd {
padding: 0 16px;
margin-bottom: 16px
}
.markdown-body code {
font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace
}
.markdown-body pre {
font: 12px SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
word-wrap: normal
}
.markdown-body blockquote,
.markdown-body dl,
.markdown-body ol,
.markdown-body p,
.markdown-body pre,
.markdown-body table,
.markdown-body ul {
margin-top: 0;
margin-bottom: 16px
}
.markdown-body blockquote {
padding: 0 1em;
color: #6a737d;
background-color: #eaecef;
border-left: .25em solid #bac6d3
}
.markdown-body blockquote>:first-child {
margin-top: 0
}
.markdown-body blockquote>:last-child {
margin-bottom: 0
}
.markdown-body table {
display: block;
width: 100%;
overflow: auto;
border-spacing: 0;
border-collapse: collapse
}
.markdown-body table th {
font-weight: 600;
background-color: #fff1af;
color: #c66e41;
}
.markdown-body table td,
.markdown-body table th {
padding: 6px 13px;
border: 1px solid #dfe2e5
}
.markdown-body table tr {
background-color: #fff;
border-top: 1px solid #c6cbd1
}
.markdown-body table tr:nth-child(2n) {
background-color: #f6f8fa
}
.markdown-body img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff
}
.markdown-body code {
padding: .2em 0;
margin: 0;
font-size: 85%;
background-color: rgba(27, 31, 35, .10);
word-break: normal;
word-wrap: normal;
border-radius: 3px
}
.markdown-body code::after,
.markdown-body code::before {
letter-spacing: -.2em;
content: "\00a0"
}
.markdown-body pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: 0 0;
border: 0
}
.markdown-body .highlight {
margin-bottom: 16px
}
.markdown-body .highlight pre {
margin-bottom: 0;
word-break: normal
}
.markdown-body .highlight pre,
.markdown-body pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f6f8fa;
border-radius: 3px
}
.markdown-body pre code {
display: inline;
max-width: auto;
padding: 0;
margin: 0;
overflow: visible;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0
}
.markdown-body pre code::after,
.markdown-body pre code::before {
content: normal
}
.markdown-body .full-commit .btn-outline:not(:disabled):hover {
color: #005cc5;
border-color: #005cc5
}
.markdown-body kbd {
box-shadow: inset 0 -1px 0 #959da5;
display: inline-block;
padding: 3px 5px;
font: 11px/10px SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
color: #444d56;
vertical-align: middle;
background-color: #fcfcfc;
border: 1px solid #c6cbd1;
border-bottom-color: #959da5;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #959da5
}
.markdown-body :checked+.radio-label {
position: relative;
z-index: 1;
border-color: #0366d6
}
.markdown-body .task-list-item {
list-style-type: none
}
.markdown-body .task-list-item+.task-list-item {
margin-top: 3px
}
.markdown-body .task-list-item input {
margin: 0 .2em .25em -1.6em;
vertical-align: middle
}
.markdown-body::before {
display: table;
content: ""
}
.markdown-body::after {
display: table;
clear: both;
content: ""
}
.markdown-body>:first-child {
margin-top: 0 !important
}
.markdown-body>:last-child {
margin-bottom: 0 !important
}
.Alert,
.Error,
.Note,
.Success,
.Warning {
padding: 11px;
margin-bottom: 24px;
border-style: solid;
border-width: 1px;
border-radius: 4px
}
.Alert p,
.Error p,
.Note p,
.Success p,
.Warning p {
margin-top: 0
}
.Alert p:last-child,
.Error p:last-child,
.Note p:last-child,
.Success p:last-child,
.Warning p:last-child {
margin-bottom: 0
}
.Alert {
color: #246;
background-color: #e2eef9;
border-color: #bac6d3
}
.Warning {
color: #4c4a42;
background-color: #fff9ea;
border-color: #dfd8c2
}
.Error {
color: #911;
background-color: #fcdede;
border-color: #d2b2b2
}
.Success {
color: #22662c;
background-color: #e2f9e5;
border-color: #bad3be
}
.Note {
color: #2f363d;
background-color: #f6f8fa;
border-color: #d5d8da
}
.Alert h1,
.Alert h2,
.Alert h3,
.Alert h4,
.Alert h5,
.Alert h6 {
color: #246;
margin-bottom: 0
}
.Warning h1,
.Warning h2,
.Warning h3,
.Warning h4,
.Warning h5,
.Warning h6 {
color: #4c4a42;
margin-bottom: 0
}
.Error h1,
.Error h2,
.Error h3,
.Error h4,
.Error h5,
.Error h6 {
color: #911;
margin-bottom: 0
}
.Success h1,
.Success h2,
.Success h3,
.Success h4,
.Success h5,
.Success h6 {
color: #22662c;
margin-bottom: 0
}
.Note h1,
.Note h2,
.Note h3,
.Note h4,
.Note h5,
.Note h6 {
color: #2f363d;
margin-bottom: 0
}
.Alert h1:first-child,
.Alert h2:first-child,
.Alert h3:first-child,
.Alert h4:first-child,
.Alert h5:first-child,
.Alert h6:first-child,
.Error h1:first-child,
.Error h2:first-child,
.Error h3:first-child,
.Error h4:first-child,
.Error h5:first-child,
.Error h6:first-child,
.Note h1:first-child,
.Note h2:first-child,
.Note h3:first-child,
.Note h4:first-child,
.Note h5:first-child,
.Note h6:first-child,
.Success h1:first-child,
.Success h2:first-child,
.Success h3:first-child,
.Success h4:first-child,
.Success h5:first-child,
.Success h6:first-child,
.Warning h1:first-child,
.Warning h2:first-child,
.Warning h3:first-child,
.Warning h4:first-child,
.Warning h5:first-child,
.Warning h6:first-child {
margin-top: 0
}
h1.title,
p.subtitle,
p.date {
text-align: center
}
h1.title.followed-by-subtitle {
margin-bottom: 0
}
p.subtitle {
font-size: 1.5em;
font-weight: 600;
line-height: 1.25;
margin-top: 0;
margin-bottom: 16px;
padding-bottom: .3em
}
div.line-block {
white-space: pre-line
}
.markdown-body img {
margin: auto;
display: block;
}
.Profe,
.Alumno,
.Cuestion {
padding: 1ex 1em 1ex 4.5em;
margin: 1em 2em 1em 0em;
border-style: solid;
border-width: 1px;
border-radius: 4px;
position: relative;
}
.Profe p,
.Alumno p,
.Cuestion p {
margin-top: 0
}
.Profe p:last-child,
.Alumno p:last-child,
.Cuestion p:last-child {
margin-bottom: 0
}
.Profe {
color: #246;
background-color: #e2eef9;
border-color: #bac6d3
}
.Alumno {
color: #4d2600;
background-color: #ffcc99;
border-color: #ff8000
}
.Cuestion {
color: #4d2600;
background-color: #ffeedc;
border-color: #ffd9b3
}
.Profe::before {
content: "üëÅ";
font-size: 42px;
position: absolute;
top: -5px;
left: 5px;
}
.Alumno::before {
content: "‚öôÔ∏è";
font-size: 42px;
position: absolute;
top: -5px;
left: 5px;
}
.Cuestion::before {
content: "üí≠";
font-size: 42px;
position: absolute;
top: -5px;
left: 5px;
}
#TOC {
width: 20%;
position: fixed;
z-index: 1;
top: 0px;
left: 0px;
padding: 0px 10px;
height: 100%;
background-color: #f6f8fa;
font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 12px;
line-height: 0.8;
overflow-y: auto;
overflow-x: hidden;
}
#TOC a {
text-decoration: none;
color: #3676ab;
}
.toc-title {
color: #999;
}
#main {
margin-left: 20%;
}
#TOC>ul {
margin-left: -2.5em;
}
#TOC>ul>li {
font-size: 18px;
line-height: 27px;
list-style-type: none;
}
#TOC>ul>li>ul>li {
font-size: 16px;
line-height: 24px;
}
#TOC>ul>li>ul>li>ul>li {
font-size: 14px;
line-height: 21px;
}
.markdown-body header {
text-align: center;
margin-bottom: 52pt;
}
@media print {
#TOC {
page-break-after: always;
}
.markdown-body {
text-align: justify;
}
}
@media print, screen and (max-width: 767px) {
.markdown-body {
padding: 2px;
text-align: left;
}
#TOC {
position: inherit;
width: 100%;
height: auto;
page-break: inherit;
}
#main {
margin-left: 0pt;
}
.markdown-body ol,
.markdown-body ul {
padding-left: 1.5em
}
.Profe,
.Alumno,
.Cuestion {
padding: 1ex 1ex 1ex 1em;
margin: 2em 0ex 2ex 2ex;
border-style: solid;
border-width: 1px;
border-radius: 4px;
position: relative;
}
.Profe::before {
content: "üëÅ";
font-size: 32px;
position: absolute;
top: -25px;
left: -20px;
}
.Alumno::before {
content: "‚öôÔ∏è";
font-size: 32px;
position: absolute;
top: -25px;
left: -20px;
}
.Cuestion::before {
content: "üí≠";
font-size: 32px;
position: absolute;
top: -25px;
left: -20px;
}
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->

</head>
<body>
<div id="wrapper">
<nav id="TOC">
<h1 class="toc-title">√çndice</h1>
<ul>
<li><a href="#introducci√≥n"><span class="toc-section-number">1</span> Introducci√≥n</a></li>
<li><a href="#resumen-de-python-para-programaci√≥n-de-red"><span class="toc-section-number">2</span> Resumen de python para programaci√≥n de red</a>
<ul>
<li><a href="#acceso-a-argumentos-de-l√≠nea-de-comandos"><span class="toc-section-number">2.1</span> Acceso a argumentos de l√≠nea de comandos</a></li>
<li><a href="#api-de-sockets"><span class="toc-section-number">2.2</span> API de sockets</a></li>
<li><a href="#cadenas-o-bytes"><span class="toc-section-number">2.3</span> ¬øCadenas o bytes?</a></li>
</ul></li>
<li><a href="#protocolo-udp"><span class="toc-section-number">3</span> Protocolo UDP</a>
<ul>
<li><a href="#p√©rdidas-de-paquetes"><span class="toc-section-number">3.1</span> P√©rdidas de paquetes</a></li>
<li><a href="#detectar-la-p√©rdida-de-paquetes"><span class="toc-section-number">3.2</span> Detectar la p√©rdida de paquetes</a></li>
<li><a href="#reenviar-paquetes-perdidos"><span class="toc-section-number">3.3</span> Reenviar paquetes perdidos</a></li>
<li><a href="#otras-mejoras"><span class="toc-section-number">3.4</span> Otras mejoras</a></li>
</ul></li>
<li><a href="#broadcast-bajo-udp"><span class="toc-section-number">4</span> Broadcast bajo UDP</a>
<ul>
<li><a href="#servidor"><span class="toc-section-number">4.1</span> Servidor</a></li>
<li><a href="#cliente"><span class="toc-section-number">4.2</span> Cliente</a></li>
</ul></li>
<li><a href="#despliegue-con-docker"><span class="toc-section-number">5</span> Despliegue con Docker</a>
<ul>
<li><a href="#instalaci√≥n-de-docker"><span class="toc-section-number">5.1</span> Instalaci√≥n de Docker</a></li>
<li><a href="#qu√©-es-docker"><span class="toc-section-number">5.2</span> ¬øQu√© es docker?</a></li>
<li><a href="#primer-ejemplo"><span class="toc-section-number">5.3</span> Primer ejemplo</a></li>
<li><a href="#lanzar-el-servidor-udp-en-un-contenedor"><span class="toc-section-number">5.4</span> Lanzar el servidor UDP en un contenedor</a></li>
<li><a href="#lanzar-el-ejemplo-broadcast"><span class="toc-section-number">5.5</span> Lanzar el ejemplo broadcast</a></li>
</ul></li>
</ul>
</nav>
<div id="main">
<article class="markdown-body">
<header>
<h1 class="title followed-by-subtitle">Sesi√≥n 1.3 Programaci√≥n de red con python. UDP</h1>
<p class="subtitle">Ingenier√≠a de Servicios</p>
<p class="date">2023-2024</p>
</header>
<div id="main-text">
<h1 data-number="1" id="introducci√≥n" data-number="1"><span class="header-section-number">1</span> Introducci√≥n</h1>
<p>Esta pr√°ctica se divide en dos sesiones, la primera para UDP y la segunda para TCP, mostrando c√≥mo usar estos protocolos de transporte para transferir datos entre dos procesos (que pueden estar en la misma o en diferentes m√°quinas), ilustrando los problemas que deben tenerse en cuenta en cada protocolo, junto con sus posibles soluciones. Estos problemas son: p√©rdidas de datagramas, retransmisiones, reordenaci√≥n, etc. para el caso UDP, y la delimitaci√≥n del mensaje (<em>framing</em>) para el caso TCP.</p>
<p>Todos los ejercicios se programar√°n en Python para simplificar la sintaxis, pero las t√©cnicas aqu√≠ utilizadas son v√°lidas para cualquier lenguaje de programaci√≥n. En particular, el alumno debe estar familiarizado con la API de sockets en C, puesto que los conceptos son los mismos.</p>
<p>Adem√°s el despliegue de los servidores se har√° con <em>docker</em>, como una forma de presentar esta herramienta que ser√° utilizada m√°s veces en pr√°cticas futuras.</p>
<h1 data-number="2" id="resumen-de-python-para-programaci√≥n-de-red" data-number="2"><span class="header-section-number">2</span> Resumen de python para programaci√≥n de red</h1>
<p>Python incluye entre sus bibliotecas est√°ndar la denominada <code>socket</code> que da acceso directo a la API de sockets del operativo, con una sintaxis simplificada pero con los mismos conceptos subyacentes que los que el alumno ya debe conocer de otros lenguajes (especialmente el C). Como veremos, la relaci√≥n entre la biblioteca de sockets de python y la API C es pr√°cticamente 1 a 1.</p>
<p>En muchos de los ejercicios que realizaremos en este curso necesitaremos pasar argumentos desde l√≠nea de comandos al programa que vamos a ejecutar. Por ejemplo, a la hora de lanzar un servidor habitualmente le pasaremos como argumento el n√∫mero de puerto en que deber√° atender peticiones, y a la hora de lanzar un cliente le pasaremos la direcci√≥n IP o nombre de la m√°quina en que se ejecuta el servidor y el n√∫mero de puerto en que √©ste est√° escuchando.</p>
<p>Comenzaremos por tanto por ver c√≥mo es el acceso a estos argumentos de l√≠nea de comandos desde el c√≥digo python.</p>
<h2 data-number="2.1" id="acceso-a-argumentos-de-l√≠nea-de-comandos" data-number="2.1"><span class="header-section-number">2.1</span> Acceso a argumentos de l√≠nea de comandos</h2>
<p>Para poder acceder a los argumentos es necesario incluir el m√≥dulo <code>sys</code>. Este m√≥dulo contiene una variable llamada <code>argv</code> que es una lista python de strings, siendo cada uno de los elementos de esta lista el valor de uno de los argumentos pasados al programa por l√≠nea de comandos. El concepto (e incluso el nombre) es el mismo que el del par√°metro <code>argv</code> de la funci√≥n <code>main</code> del C, pero con las siguientes diferencias:</p>
<ul>
<li>En python no es un par√°metro de ninguna funci√≥n, sino una variable ‚Äúglobal‚Äù del m√≥dulo <code>sys</code>, por tanto accederemos a ella por el nombre <code>sys.argv</code></li>
<li>En python no existe el par√°metro <code>argc</code> t√≠pico del C que nos dec√≠a cu√°ntos par√°metros hab√≠a recibido el programa. No es necesario este par√°metro en python ya que la propia longitud del array anterior nos da este dato. Recordemos que esta longitud se halla con <code>len(sys.argv)</code></li>
</ul>
<h2 data-number="2.2" id="api-de-sockets" data-number="2.2"><span class="header-section-number">2.2</span> API de sockets</h2>
<p>El m√≥dulo <code>socket</code> contiene todo lo necesario para acceder a las funciones de manejo de sockets a bajo nivel (a nivel de la API C). Las t√≠picas funciones que ya conoces del lenguaje C tienen su contrapartida en python, pero la sintaxis de algunas de ellas se ha simplificado. Rese√±amos las diferencias m√°s importantes:</p>
<ul>
<li><p><code>socket()</code> crea un socket nuevo y lo devuelve como resultado. A diferencia del C, se pueden omitir los par√°metros en esta funci√≥n, y por defecto crear√° un socket de tipo <code>AF_INET</code>, para el protocolo <code>SOCK_STREAM</code> sobre IPv4 (tercer par√°metro 0). En caso de que se quiera un socket UDP, es necesario especificar los dos primeros par√°metros (el tercero puede omitirse) como sigue:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> socket</span>
<span id="cb1-2"><a href="#cb1-2"></a>s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span></code></pre></div>
<p>El socket devuelto por esta funci√≥n es un <em>objeto</em> en python (a diferencia del C donde era un entero). La mayor√≠a de las funciones que operan sobre este socket ser√°n m√©todos de este objeto.</p></li>
<li><p><code>bind()</code> asigna a un socket previamente creado una direcci√≥n y un puerto. Las diferencias m√°s importantes con el lenguaje C son:</p>
<ul>
<li>El socket no se pasa como par√°metro, sino que <code>bind()</code> es un m√©todo del objeto socket.</li>
<li>La direcci√≥n y puerto no se pasan en una estructura <code>sockaddr</code>, sino en una tupla de dos elementos, siendo el primero la direcci√≥n (un string) y el segundo el puerto (un entero).</li>
<li>La direcci√≥n es un string que puede contener una IP (con notaci√≥n de puntos), o un nombre de una m√°quina, en cuyo caso la funci√≥n internamente resolver√° el nombre en una IP. Lo m√°s habitual es que queramos especificar como IP la constante especial <code>INADDR_ANY</code>, que en python ser√≠a <code>socket.INADDR_ANY</code>, o tambi√©n la IP <code>&quot;0.0.0.0&quot;</code>, que es exactamente lo mismo, o m√°s sencillo a√∫n, la IP <code>&quot;&quot;</code> (cadena vac√≠a) que python convertir√° en la constante anterior.</li>
</ul>
<p>Por tanto, un ejemplo de asignaci√≥n del puerto 8080 a un socket previamente creado ser√≠a:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>s.bind((<span class="st">&quot;&quot;</span>, <span class="dv">8080</span>))</span></code></pre></div>
<p>Observa que en realidad la funci√≥n recibe un √∫nico par√°metro, aunque parecen dos, que es la tupla que contiene IP y puerto. De ah√≠ que aparezcan duplicados los par√©ntesis.</p></li>
<li><p><code>listen()</code>, aplicable a sockets TCP, convierte el socket en pasivo (para aceptar conexiones). Recibe como par√°metro el n√∫mero m√°ximo de clientes que se mantendr√°n a la espera de un <code>accept()</code>, los que lleguen despu√©s ser√°n rechazados por el operativo.</p></li>
<li><p><code>accept()</code> espera clientes en un socket pasivo TCP. A diferencia de la versi√≥n C, en python esta funci√≥n no recibe par√°metros y retorna dos resultados (una tupla). El primero de ellos es un nuevo socket sobre el que se har√° la lectura/escritura y el segundo es un par <em>(direccion, puerto)</em> correspondientes al cliente que se acaba de aceptar.</p></li>
<li><p><code>connect()</code> tiene una sintaxis an√°loga a la de <code>bind()</code> antes explicada.</p></li>
<li><p><code>send()</code>, aplicable a sockets TCP, recibe un √∫nico par√°metro que es una cadena de bytes de python. No es necesario especificar el socket por el que se env√≠a, ya que en realidad <code>send()</code> es un m√©todo de ese objeto socket, ni es necesario especificar el n√∫mero de bytes a enviar, ya que la longitud de la cadena de bytes proporciona ese dato. Por tanto un ejemplo ser√≠a:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>s.send(b<span class="st">&quot;Este mensaje se envia por el socket&quot;</span>)</span></code></pre></div>
<p>Observa la <code>b</code> delante de las comillas. Esto es sintaxis de Python3 y sirve para identificar la cadena en cuesti√≥n como una cadena de bytes, en lugar de una cadena de caracteres Unicode, que ser√≠a lo que tendr√≠amos si no hubi√©ramos puesto la <code>b</code> delante. Sin esa <code>b</code>, tendr√≠amos un error al tratar de enviar caracteres Unicode por un socket, ya que la API de sockets s√≥lo puede enviar bytes. ¬øCu√°l es la diferencia? Si estamos trabajando con caracteres ASCII, como es el caso del ejemplo anterior, cada uno de los caracteres se codifica en un byte por lo que la cadena de bytes es en realidad la cadena de c√≥dicos ASCII de lo que va entre comillas. Sin embargo, si trabajamos con caracteres no ASCII (por ejemplo, acentos o e√±es), entonces la codificaci√≥n de la cadena ya no necesariamente ser√° un byte por letra. Depende de si usamos utf-8, utf-16 u otros <em>encodings</em>.</p>
<p>Al igual que en C, esta funci√≥n no garantiza el env√≠o de todos los bytes que componen el mensaje, puede que se env√≠en s√≥lo parte de ellos. La funci√≥n retorna un entero que indica cu√°ntos ha enviado con √©xito. Es responsabilidad del programador chequear ese valor y enviar de nuevo lo que falte. En C esto t√≠picamente se hace mediante un bucle que vaya actualizando el puntero a los datos y el n√∫mero de bytes que a√∫n faltan por enviar. En python se puede simplificar enormemente la programaci√≥n haciendo uso de la funci√≥n <code>socket.sendall()</code>, que no forma parte de la API C, sino que es proporcionada por la biblioteca python. Como su nombre sugiere, esta funci√≥n asegura que todos los bytes son enviados, para lo cual contiene un bucle como el descrito. El problema es que si la red est√° congestionada y todos los buffers llenos, la funci√≥n ser√° bloqueante hasta que todos los datos hayan podido ser enviados.</p></li>
<li><p><code>recv()</code>, aplicable a sockets TCP, recibe como par√°metro el n√∫mero de bytes que se quieren recibir y retorna una cadena de bytes, con los bytes recibidos. Aplicando <code>len()</code> sobre esa cadena podremos saber el n√∫mero de ellos recibidos. Si retorna una cadena vac√≠a (cuya <code>len()</code> ser√≠a cero), ser√≠a un indicador de que el otro extremo de la comunicaci√≥n ha cerrado el socket (un ‚Äúfin de transmisi√≥n‚Äù). Si no hay bytes disponibles, la funci√≥n se bloquear√° hasta que los haya.</p></li>
<li><p><code>sendto()</code>, aplicable a sockets UDP recibe dos par√°metros. El primero es la cadena de bytes, que contiene los bytes a enviar en el datagrama (como en <code>send()</code>), y el segundo es una tupla de dos elementos <em>(direcci√≥n, puerto)</em> como la explicada en <code>connect()</code> o en <code>bind()</code>. V√©ase el ejemplo del punto siguiente.</p></li>
<li><p><code>recvfrom()</code>, aplicable a sockets UDP, recibe un √∫nico par√°metro que es un entero especificando el n√∫mero de bytes m√°ximo esperado en el datagrama. La funci√≥n retorna una tupla con dos elementos, siendo el primero una cadena de bytes, con los bytes del datagrama recibido, y el segundo una tupla con la <em>(direcci√≥n, puerto)</em> del que proviene el datagrama. Cuando una funci√≥n python retorna una tupla, √©sta puede asignarse a dos variables separadas. As√≠ pues, el siguiente ejemplo quedar√≠a esperando a recibir un datagrama y lo mostrar√≠a por pantalla adem√°s de devolverlo a modo de ‚Äúeco‚Äù a su origen:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>datagrama, origen <span class="op">=</span> s.revfrom(<span class="dv">1024</span>)  <span class="co"># 1024 es el m√°ximo tama√±o esperado</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="bu">print</span>(<span class="st">&quot;Se ha recibido un datagrama desde&quot;</span>, origen)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="bu">print</span>(<span class="st">&quot;Contiene lo siguiente:&quot;</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="bu">print</span>(datagrama.decode(<span class="st">&quot;utf-8&quot;</span>))</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># Ahora lo devolvemos a modo de eco</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>s.sendto(datagrama, origen)</span></code></pre></div></li>
</ul>
<h2 data-number="2.3" id="cadenas-o-bytes" data-number="2.3"><span class="header-section-number">2.3</span> ¬øCadenas o bytes?</h2>
<p>Como hemos visto, Python3 tiene dos tipos de cadenas. Las de caracteres, reconocibles por ir entre comilas como <code>&quot;√©sta&quot;</code>, y las de bytes, reconocibles por llevar una <code>b</code> delante de las comillas, como <code>b&quot;esta&quot;</code>. Si asignas la primera a una variable, el tipo de la variable ser√° <code>str</code>, mientras que en el segundo caso ser√° <code>bytes</code>.</p>
<p>Las cadenas de caracteres (<code>str</code>) son almacenadas internamente como secuencias de caracteres Unicode y por tanto admiten tildes, e√±es y otros alfabetos, y las funciones de formateo, conteo de caracteres, paso a may√∫sculas y min√∫sculas, comparaci√≥n para ordenaci√≥n, etc. funcionar√°n correctamente tambi√©n con otros alfabetos (incluido el latino).</p>
<p>Las cadenas de <code>bytes</code> son almacenadas internamente como secuencias de bytes sin que Python entre a dar un significado a esos bytes. Son simplemente un vista de una parte de la memoria. Los bytes en cuesti√≥n podr√≠an ser parte de una imagen, de un sonido, o tambi√©n, por qu√© no, de una cadena de texto ASCII o incluso de la representaci√≥n en UTF-8 de una cadena unicode. Sin embargo no deben usarse estas cadenas de bytes para almacenar texto no ASCII porque funciones como <code>len()</code> no funcionar√≠an correctamente (retornar√≠a el n√∫mero de bytes, que no necesariamente coincidir√° con el n√∫mero de caracteres).</p>
<p>Dada una cadena de caracteres, <code>str</code>, es siempre posible convertirlo a una representaci√≥n de bytes, ya que Unicode a fin de cuentas tiene tambi√©n una representaci√≥n binaria. El problema es que la representaci√≥n binaria de un caracter Unicode depende del <em>encoding</em> elegido. As√≠ el caracter <code>&quot;√±&quot;</code> tiene diferente representaci√≥n binaria seg√∫n se codifique en <code>latin1</code>, <code>cp850</code>, <code>utf8</code>, etc. La funci√≥n que permite convertir un <code>str</code> en <code>bytes</code> se llama <code>bytes()</code> y recibe como par√°metros la cadena a convertir y el nombre del <em>encoding</em> a utilizar. Por ejemplo:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="op">&gt;&gt;&gt;</span> a <span class="op">=</span> <span class="st">&quot;√±&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">bytes</span>(a, <span class="st">&quot;utf8&quot;</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a>b<span class="st">&#39;</span><span class="ch">\xc3\xb1</span><span class="st">&#39;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">bytes</span>(a, <span class="st">&quot;latin&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a>b<span class="st">&#39;</span><span class="ch">\xf1</span><span class="st">&#39;</span></span></code></pre></div>
<p>Vemos en el ejemplo anterior que la cadena almacenada en la variable <code>a</code> tiene como representaci√≥n binaria, usando la codificaci√≥n <code>latin1</code>, un solo byte de valor <code>f1</code>, y sin embargo su representaci√≥n binaria en <code>utf8</code> requiere dos bytes de valor <code>c3</code>, <code>b1</code>.</p>
<p>Es posible tambi√©n obtener la representaci√≥n en <code>bytes</code> de un <code>str</code> a trav√©s de su m√©todo <code>.encode()</code>. Por ejemplo:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="op">&gt;&gt;&gt;</span> a.encode(<span class="st">&quot;utf8&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>b<span class="st">&#39;</span><span class="ch">\xc3\xb1</span><span class="st">&#39;</span></span></code></pre></div>
<p>La conversi√≥n de <code>bytes</code> a <code>str</code> tambi√©n es posible, pero en general m√°s compleja debido a que necesitamos conocer de antemano qu√© codificaci√≥n se us√≥ para obtener la secuencia de bytes, y as√≠ poder aplicar la misma para decodificarlo como cadena. Por ejemplo, si tenemos en una variable la secuencia de bytes <code>b&quot;\xc3\xb1&quot;</code> necesitamos saber que est√° en utf-8 para poder decodificarla y obtener <code>&quot;√±&quot;</code>, puesto que esa misma secuencia tambi√©n podr√≠a decodificarse bajo <code>latin1</code> dando otro resultado (<code>&quot;√É¬±&quot;</code>). La funci√≥n para hacer esta conversi√≥n es <code>str()</code> y recibe como par√°metros la cadena de <code>bytes</code> a convertir y el <em>encoding</em> que queremos usar para la decodificaci√≥n. Por ejemplo:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">&gt;&gt;&gt;</span> a <span class="op">=</span> b<span class="st">&quot;</span><span class="ch">\xc3\xb1</span><span class="st">&quot;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">type</span>(a)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="op">&lt;</span><span class="kw">class</span> <span class="st">&#39;bytes&#39;</span><span class="op">&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">str</span>(a, <span class="st">&quot;utf8&quot;</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">&#39;√±&#39;</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">str</span>(a, <span class="st">&quot;latin1&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">&#39;√É¬±&#39;</span></span></code></pre></div>
<p>Es posible tambi√©n obtener la decodificaci√≥n como <code>str</code> de una variable typo <code>bytes</code> a trav√©s de su m√©todo <code>.decode()</code>. Por ejemplo:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="op">&gt;&gt;&gt;</span> a.decode(<span class="st">&quot;utf8&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co">&#39;√±&#39;</span></span></code></pre></div>
<p>Para el manejo de texto las cadenas de tipo <code>str</code> son la norma. Sin embargo cuando es necesario hacer Entrada/Salida (guardar el texto en un fichero o leerlo del mismo, enviarlo o recibirlo por un socket, etc.) ser√° necesario convertirlo en bytes, ya que las APIs de entrada/salida funcionan con bytes. La duda habitual es ¬øcu√°ndo hacer esta conversi√≥n? Es decir, al leer del fichero a una variable, el resultado ser√° de tipo <code>bytes</code> ¬øconviene dejar esta variable con este tipo durante todo el programa y convertirla a Unicode (es decir, al tipo <code>str</code>) s√≥lo cu√°ndo sea necesario tratarlo como cadena? ¬øO por el contrario es m√°s conveniente convertirla a Unicode justo tras leerla y ya tratarla como <code>str</code> durante el resto del programa?</p>
<p>La regla general recomendada es la segunda. Es decir, convertir las secuencias de <code>bytes</code> a <code>str</code> tan pronto como son leidas/recibidas y trabajar con ellas todo el rato como <code>str</code>, y convertirlas de nuevo a <code>bytes</code> si han de ser enviadas a un fichero, o por un socket, justo antes de este env√≠o. Dicho de otra forma, trabajar con su forma <code>bytes</code> el menor tiempo posible, y solo en las operaciones de Entrada/Salida, prefiriendo su forma <code>str</code> para todo lo dem√°s.</p>
<p>Naturalmente lo anterior se aplica s√≥lo al caso de que la secuencia de <code>bytes</code> sea en realidad la representaci√≥n de un texto. Si no representa texto sino otro tipo de informaci√≥n binaria, no tiene sentido (ni ser√° posible en general) convertirlo a una cadena de tipo <code>str</code>, y en este caso se trabajar√≠a todo el rato con su representaci√≥n de <code>bytes</code>.</p>
<p>Siguiendo esta regla, la forma t√≠pica de leer de un socket (asumiendo que lo que leemos es texto codificado en UTF8) ser√≠a:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>texto <span class="op">=</span> s.recv(<span class="dv">50</span>)   <span class="co"># Recibimos 50 bytes (maximo)</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>texto <span class="op">=</span> texto.decode(<span class="st">&quot;utf8&quot;</span>) <span class="co"># Lo pasamos lo antes posible a cadena</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="bu">print</span>(<span class="st">&quot;Texto recibido:&quot;</span>, texto)  <span class="co"># El resto del programa lo trata como cadena</span></span></code></pre></div>
<p>Y la forma t√≠pica de enviar un texto por un socket (usando UTF8) ser√≠a:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># La variable texto se ha inicializado de alg√∫n modo conteniendo un str</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># Por ejemplo, se ha leido con input()</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>enviados <span class="op">=</span> s.send(texto.encode(<span class="st">&quot;utf8&quot;</span>)) <span class="co"># A la hora de enviarlo lo paso a bytes</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># Cuidado que la variable enviados contendr√° el n√∫mero de bytes enviados</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># y no el n√∫mero de caracteres</span></span></code></pre></div>
<p>Si te das cuenta, el ejemplo de lectura plantea un problema. Ya que hemos limitado a 50 bytes lo leido, ¬øqu√© ocurre si en realidad nos hab√≠an enviado m√°s de 50? Recibir√≠amos s√≥lo los 50 primeros, los cuales quiz√°s no puedan ser correctamente decodificados como UTF8 si ha dado la casualidad de que un caracter multi-byte ha quedado ‚Äúpartido‚Äù entre los 50 primeros y los siguientes. Este problema aparece en TCP debido a que el socket es tratado como un ‚Äúflujo‚Äù de datos que puede ser troceado de diferentes formas cuando es leido. En UDP el problema no aparece porque el datagrama es ‚Äúat√≥mico‚Äù (se lee siempre completo, no puede ser partido en dos lecturas). En una futura pr√°ctica volveremos al problema con TCP. La pr√°ctica actual se dedica a UDP.</p>
<h1 data-number="3" id="protocolo-udp" data-number="3"><span class="header-section-number">3</span> Protocolo UDP</h1>
<p>Bajo UDP la comunicaci√≥n se reduce a un env√≠o de datagrama con <code>sendto()</code> y la correspondiente recepci√≥n con <code>recvfrom()</code>. La capa de transporte har√° ‚Äútodo lo posible‚Äù (<em>best effort</em>) porque el datagrama llegue a destino, pero no ofrece garant√≠as. El datagrama es una unidad, o llega completo o se pierde completo. Si el emisor env√≠a varios datagramas, pueden recibirse en diferente orden.</p>
<p>Comencemos con un sencillo ejemplo en que no se tienen en cuenta ninguno de estos problemas.</p>
<div class="Alumno">
<p><strong>Ejercicio 1</strong></p>
<ol type="1">
<li>Escribe un servidor UDP que escuche en el puerto que se le pase por l√≠nea de comandos, o en el 9999 por defecto. El servidor estar√° en un bucle infinito en el que, para cada datagrama que llegue, imprimir√° en pantalla el contenido del datagrama y la direcci√≥n de la cual proviene. Gu√°rdalo como <code>udp_servidor1.py</code></li>
<li>Escribe un cliente UDP que, en un bucle, lea una l√≠nea de texto del teclado y se la env√≠e en un datagrama al servidor anterior, hasta que la l√≠nea le√≠da sea FIN. El cliente recibir√° por l√≠nea de comandos la IP y puerto del servidor, o asumir√° como valores por defecto ‚Äúlocalhost‚Äù y 9999. Gu√°rdalo como <code>udp_cliente1.py</code></li>
<li>Prueba a ejecutar el servidor en una terminal y el cliente en otra. Prueba tambi√©n con cliente y servidor en diferentes m√°quinas (es decir, usa el servidor de tu compa√±ero con tu cliente o viceversa).</li>
</ol>
</div>
<h2 data-number="3.1" id="p√©rdidas-de-paquetes" data-number="3.1"><span class="header-section-number">3.1</span> P√©rdidas de paquetes</h2>
<p>Ya que en una red local es dif√≠cil que se pierdan paquetes (imposible adem√°s si cliente y servidor est√°n en la misma m√°quina), tendremos que ‚Äúsimular‚Äù que esto ocurra. Para ello:</p>
<div class="Alumno">
<p><strong>Ejercicio 2</strong></p>
<ol type="1">
<li>Modifica el servidor anterior para que, tras recibir el datagrama, decida aleatoriamente con una probabilidad del 50% si simular√° no haberlo recibido. En este caso imprimir√° en pantalla ‚ÄúSimulando paquete perdido‚Äù, en otro caso imprimir√° en pantalla el contenido del datagrama tal como hac√≠a antes. Para generar n√∫meros aleatorios usar el m√≥dulo <code>random</code>, por ejemplo la funci√≥n <code>randint()</code>. Guarda el programa con el nombre <code>udp_servidor2_simula_perdidas.py</code>.</li>
<li>Modifica el cliente para que a√±ada al principio de cada datagrama un n√∫mero (su representaci√≥n como string) que vaya increment√°ndose por cada datagrama enviado. As√≠, por ejemplo, si el usuario escribe ‚ÄúHola‚Äù, el datagrama enviado ser√° ‚Äú1: Hola‚Äù y el ‚Äú1‚Äù se ir√° incrementando para sucesivos datagramas. Guarda el programa con el nombre <code>udp_cliente2_numera_mensajes.py</code>.</li>
<li>Ejecutar servidor y cliente y comprobar c√≥mo algunos de los datagramas se pierden y por tanto la secuencia de n√∫meros tiene saltos. En caso de que cliente y servidor estuvieran separados por muchos nodos intermedios podr√≠a incluso observarse que algunos de los n√∫meros llegan fuera de orden.</li>
</ol>
</div>
<h2 data-number="3.2" id="detectar-la-p√©rdida-de-paquetes" data-number="3.2"><span class="header-section-number">3.2</span> Detectar la p√©rdida de paquetes</h2>
<p>Como vemos, el cliente no sabe nunca realmente si el paquete ha llegado o no a destino. De hecho ¬°el cliente funciona exactamente igual incluso si el servidor no est√° corriendo! Una forma de mejorar √©sto ser√≠a que el servidor respondiera con otro datagrama de ‚Äúreconocimiento‚Äù.</p>
<div class="Alumno">
<p><strong>Ejercicio 3</strong></p>
<p>Modifica el servidor anterior para que, en caso de que decida no perder el paquete, adem√°s de mostrarlo por pantalla env√≠e al cliente otro datagrama conteniendo el texto ‚ÄúOK‚Äù. Gu√°rdalo con el nombre <code>udp_servidor3_con_ok.py</code>.</p>
</div>
<p>Lo siguiente ser√≠a modificar el cliente para que, tras enviar un datagrama, haga un <code>recvfrom()</code> para recibir el ‚ÄúOK‚Äù del servidor. Pero ¬øy si el datagrama del cliente se hab√≠a perdido? No habr√° entonces ning√∫n ‚ÄúOK‚Äù para recibir y el cliente quedar√° bloqueado en el <code>recvfrom()</code> a la espera de un ‚ÄúOK‚Äù que nunca llegar√°. Y lo mismo puede ocurrir tambi√©n (aunque no en esta pr√°ctica debido a que estamos en modo local) si el datagrama con el ‚ÄúOK‚Äù del servidor se perdiera.</p>
<p>Es necesario incluir un <em>timeout</em> en el cliente, de modo que si transcurrido un tiempo razonable no se ha recibido el ‚ÄúOK‚Äù se pueda asumir que estamos ante un error de red.</p>
<h3 data-number="3.2.1" id="incluir-timeouts-en-las-recepciones-de-datos" data-number="3.2.1"><span class="header-section-number">3.2.1</span> Incluir <em>timeouts</em> en las recepciones de datos</h3>
<p>B√°sicamente se trata de llamar a la funci√≥n <code>settimeout()</code> del objeto socket pas√°ndole el n√∫mero de segundos m√°ximo a esperar (puede ser un n√∫mero fraccionario), antes de invocar <code>recvfrom()</code>. En ese caso la llamada a <code>recvfrom()</code> se bloquear√° hasta recibir un datagrama o hasta que expire el <em>timeout</em>, lo que ocurra antes. Si recibe el datagrama retornar√° en la forma habitual. Si expira el <em>timeout</em> generar√° una excepci√≥n llamada <code>socket.timeout</code>. Capturando esta excepci√≥n podemos tomar control sobre el error.</p>
<p>En python las excepciones se tratan poniendo el c√≥digo que podr√≠a generarlas dentro de una clausula <code>try</code>, y seguidamente el c√≥digo que maneja las excepciones en una cl√°usula <code>except</code>, como muestra el c√≥digo siguiente.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># Ejemplo de recepci√≥n de un datagrama con un timeout m√°ximo de una d√©cima de segundo</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># Se supone inicializada la variable s con una llamada a socket</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># y que ya se ha enviado un datagrama y se est√° esperando la respuesta &quot;OK&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>s.settimeout(<span class="fl">0.1</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="cf">try</span>:</span>
<span id="cb11-7"><a href="#cb11-7"></a>    datagrama, origen <span class="op">=</span> s.recvfrom(<span class="dv">1024</span>) <span class="co"># Tama√±o m√°ximo a recibir</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>    datagrama <span class="op">=</span> datagrama.decode(<span class="st">&quot;utf8&quot;</span>)</span>
<span id="cb11-9"><a href="#cb11-9"></a>    <span class="cf">if</span> datagrama<span class="op">==</span><span class="st">&quot;OK&quot;</span>:</span>
<span id="cb11-10"><a href="#cb11-10"></a>       <span class="bu">print</span>(<span class="st">&quot;Recibida confirmaci√≥n&quot;</span>)</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="cf">else</span>:</span>
<span id="cb11-12"><a href="#cb11-12"></a>       <span class="bu">print</span>(<span class="st">&quot;Recibido datagrama no esperado&quot;</span>)</span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="cf">except</span> socket.timeout:</span>
<span id="cb11-14"><a href="#cb11-14"></a>    <span class="bu">print</span>(<span class="st">&quot;ERROR. El datagrama de confirmaci√≥n no llega&quot;</span>)</span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="cf">except</span>:    <span class="co"># Otras posibles excepciones dejamos que las maneje el usuario</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="cf">raise</span></span></code></pre></div>
<div class="Alumno">
<p><strong>Ejercicio 3 (continuaci√≥n)</strong></p>
<p>Modifica el cliente y gu√°rdalo con el nombre <code>udp_cliente3_espera_ok.py</code> para que tras cada datagrama enviado espere la confirmaci√≥n, pero limitando el tiempo de espera como se mostr√≥ en el c√≥digo anterior.</p>
<p>Ejecuta los nuevos cliente y servidor y comprueba c√≥mo cuando el servidor ‚Äúdecide‚Äù simular la p√©rdida de un paquete, el cliente detecta correctamente la no recepci√≥n del datagrama.</p>
</div>
<h2 data-number="3.3" id="reenviar-paquetes-perdidos" data-number="3.3"><span class="header-section-number">3.3</span> Reenviar paquetes perdidos</h2>
<p>El cliente no deber√≠a limitarse a detectar el error, sino que deber√≠a hacer algo por resolverlo. El enfoque t√≠pico consiste en reenviar el paquete cuya confirmaci√≥n no se hab√≠a recibido, aumentando el <em>timeout</em> entre reintentos. Si el <em>timeout</em> alcanza un cierto valor que consideramos inadmisible, el cliente podr√° asumir que el servidor est√° ca√≠do y abandonar ya los reintentos.</p>
<div class="Alumno">
<p><strong>Ejercicio 4</strong></p>
<p>Modifica el cliente anterior y gu√°rdalo como <code>udp_cliente4_reintenta.py</code> de modo que en caso de agotar el tiempo de espera (<em>timeout</em>), el cliente repita el env√≠o, duplicando en cada reenv√≠o el valor del <em>timeout</em> hasta que, bien se reciba el ‚ÄúOK‚Äù, bien el <em>timeout</em> exceda el valor de 2 segundos. En el primer caso volver√° a pedir datos al usuario para volver a enviarlos al servidor, usando el mismo esquema. En el segundo caso imprimir√° un mensaje ‚ÄúPuede que el servidor est√© ca√≠do. Int√©ntelo m√°s tarde‚Äù y finalizar√° su ejecuci√≥n. Observa que en los reintentos el n√∫mero de secuencia del datagrama no se debe incrementar.</p>
<p>Ejecuta el cliente anterior junto con el servidor anterior, <code>udp_servidor3_con_ok.py</code> y comprueba que funcione.</p>
<p>Ejecuta el cliente usando como IP y puerto unas en las que no haya ning√∫n servidor escuchando. Comprueba c√≥mo detecta correctamente el problema (tras varios reintentos) y termina su ejecuci√≥n.</p>
</div>
<h2 data-number="3.4" id="otras-mejoras" data-number="3.4"><span class="header-section-number">3.4</span> Otras mejoras</h2>
<p>El protocolo anterior no es muy robusto. En primer lugar el datagrama de confirmaci√≥n contiene meramente ‚ÄúOK‚Äù y ninguna indicaci√≥n de cu√°l es el datagrama que est√° confirmando. Si tenemos en cuenta que los datagramas pueden llegar al servidor desordenados, cuando el cliente recibe un ‚ÄúOK‚Äù no tiene forma de saber a cu√°l de los datagramas que envi√≥ previamente corresponde esta confirmaci√≥n.</p>
<p>Adem√°s, imagina que el cliente env√≠a un primer datagrama (datagrama 1), la confirmaci√≥n tarda demasiado en llegar y decide reenviarlo. Recibe un ‚ÄúOK‚Äù y a continuaci√≥n env√≠a un segundo datagrama (datagrama 2), para el que recibe inmediatamente otro ‚ÄúOK‚Äù. Parece que ambos datagramas llegaron a destino (el 1 tras un reintento). Pero en realidad pudo ocurrir otra cosa muy diferente. Quiz√°s cuando se envi√≥ el datagrama 1 la red iba m√°s lenta por lo que tard√≥ en llegar a destino, pero lleg√≥ finalmente, y el servidor confirm√≥ con un ‚ÄúOK‚Äù. Poco despu√©s llega el reenv√≠o del datagrama 1 que el servidor confirma con otro ‚ÄúOK‚Äù. El datagrama 2 en cambio se pierde. La situaci√≥n por tanto es que el datagrama 1 lleg√≥ dos veces (y se confirm√≥ dos veces), mientras que el datagrama 2 se perdi√≥, y sin embargo el cliente ‚Äúcree‚Äù que ambos llegaron (y una sola vez cada uno).</p>
<p>Estos problemas se pueden aliviar incluyendo en cada datagrama alg√∫n tipo de identificador, que sea diferente para cada datagrama, pero el mismo para los reenv√≠os, y usando en el mensaje de confirmaci√≥n el identificador del datagrama que est√° siendo confirmado. El n√∫mero de secuencia de los ejemplos anteriores podr√≠a servir como identificador, pero en general es preferible usar identificadores m√°s dif√≠ciles de adivinar. Un n√∫mero aleatorio o un hash criptogr√°fico ser√≠an m√°s apropiados.</p>
<p>Por otro lado, este servidor es muy simple y se limita a mostrar en pantalla los datagramas recibidos, sin realizar ning√∫n tipo de procesamiento. En un caso real el servidor tendr√° que realizar alguna acci√≥n con los datagramas recibidos. Se corre entonces el riesgo de repetir la acci√≥n debido a la recepci√≥n de duplicados. Por ejemplo, el cliente env√≠a un primer datagrama que llega correctamente a destino y causa que el servidor ejecute alguna acci√≥n. Pero el datagrama con la confirmaci√≥n se pierde, por lo que el cliente, tras agotar su <em>timeout</em> reenv√≠a el mismo datagrama. Cuando √©ste llegue por segunda vez causar√° que la acci√≥n desencadenada por el primero se repita. En algunos casos esto puede no ser admisible.</p>
<p>Este segundo problema se solventa haciendo que el servidor mantenga una lista de qu√© identificadores de datagrama ha recibido, y cuando reciba otro con el mismo identificador se limitar√° a reenviar la confirmaci√≥n, pero sin ejecutar de nuevo la acci√≥n asociada.</p>
<p>Finalmente, cuando el cliente est√° esperando la confirmaci√≥n lo hace llamando a <code>recvfrom()</code>, lo cual en principio le abre a recibir cualquier datagrama de cualquier otro proceso, no necesariamente del servidor con quien estaba comunic√°ndose. Por ejemplo, un cliente malicioso podr√≠a enviar a nuestro cliente un datagrama con un ‚ÄúOK‚Äù para confundirle. El cliente deber√≠a comprobar que la IP de origen del datagrama de confirmaci√≥n es la que debe ser (dejando de lado ataques m√°s complejos como <em>IP spoofing</em>). Una forma m√°s simple de hacer lo mismo es usar en el cliente la funci√≥n <code>connect()</code> y seguidamente usar <code>recv()</code> para recibir los datagramas. Estas funciones t√≠picamente se asocian a TCP para establecer un canal y leer de √©l, pero tambi√©n es posible usarlas en UDP si bien tienen otro significado. En UDP <code>connect()</code> simplemente ‚Äúdeclara‚Äù la IP y puerto de la que esperamos recibir datagramas (ser√≠an las del servidor), pero no inicia ninguna actividad de red ni crea ning√∫n tipo de conexi√≥n. Seguidamente <code>recv()</code> funcionar√° como <code>recvfrom()</code>, pero descartando autom√°ticamente todos los datagramas que no vengan de la IP y puerto especificados previamente en <code>connect()</code>.</p>
<div class="Alumno">
<p><strong>Ejercicio 5 (opcional)</strong></p>
<p>Implementa al menos una de las mejoras propuestas en este apartado. Llama a los ficheros <code>udp_servidor5_mejorado.py</code> y <code>udp_cliente5_mejorado.py</code>.</p>
</div>
<h1 data-number="4" id="broadcast-bajo-udp" data-number="4"><span class="header-section-number">4</span> Broadcast bajo UDP</h1>
<p>UDP soporta <em>broadcast</em>. Esta es la capacidad de enviar un datagrama no a un nodo concreto, sino a <em>todos</em> los nodos conectados a una subred. Esto es √∫til para implementar clientes que se autoconfiguran, descubriendo por s√≠ mismos cu√°l es la IP de los servidores que implementan los servicios deseados. Por ejemplo, el protocolo DHCP para obtener la configuraci√≥n de red utiliza esta t√©cnica.</p>
<p>Para ejemplificar estas ideas inventamos un simple protocolo que llamaremos ‚ÄúHOLA‚Äù. Este protocolo consiste simplemente en esperar en un puerto prefijado por un datagrama que diga ‚ÄúHOLA‚Äù y responderle al cliente con otro datagrama que diga ‚ÄúHOLA: IP‚Äù donde ‚ÄúIP‚Äù es la IP de ese cliente.</p>
<p>El cliente desconoce inicialmente la IP del servidor, y usar√° la t√©cnica del broadcast para que lo descubra. Para ello el cliente enviar√° por broadcast a todas las m√°quinas de la subred un datagrama que contenga el texto ‚ÄúBUSCANDO HOLA‚Äù al puerto prefijado, y esperar√° respuestas de posibles servidores. Mostrar√° en pantalla las IPs de los servidores que han respondido y tomar√° la primera de ellas para probar el servicio.</p>
<p>Seguidamente damos m√°s detalles de c√≥mo implementar tanto el servidor como el cliente.</p>
<h2 data-number="4.1" id="servidor" data-number="4.1"><span class="header-section-number">4.1</span> Servidor</h2>
<p>Crea un socket UDP en un puerto predeterminado que ser√° el 12345 y espera a recibir datagramas en √©l. El socket debe estar en ‚Äúmodo broadcast‚Äù para que pueda recibir datagramas dirigidos a la subred en que se halla. Para cada datagrama que reciba examinar√° su contenido para ver si est√° en uno de los siguientes casos:</p>
<ul>
<li><p>Si el datagrama contiene el texto ‚ÄúBUSCANDO HOLA‚Äù responder√° al cliente en cuesti√≥n con otro datagrama conteniendo ‚ÄúIMPLEMENTO HOLA‚Äù, para notificarle que √©ste servidor implementa ese servicio. Cuando el cliente reciba este datagrama podr√° saber la IP del servidor, ya que esta llegar√° tambi√©n como parte de <code>recvfrom()</code>.</p></li>
<li><p>Si el datagrama contiene simplemente ‚ÄúHOLA‚Äù, responde al cliente con otro que contiene ‚ÄúHOLA: IP‚Äù siendo ‚ÄúIP‚Äù la del cliente a quien env√≠a el datagrama, es decir, da el servicio en cuesti√≥n.</p></li>
</ul>
<p>Para poner un socket en ‚Äúmodo <em>broadcast</em>‚Äù es necesario utilizar la funci√≥n <code>setsockopt()</code>. Esta es una funci√≥n de la API est√°ndar de sockets en C, y su sintaxis y funcionalidad puede consultarse en la correspondiente <a href="http://www.manpagez.com/man/2/setsockopt/">p√°gina de manual</a>, si bien se trata de una funci√≥n muy vers√°til que puede realizar un gran n√∫mero de operaciones seg√∫n el protocolo y las opciones que se le pasen. Nos centraremos √∫nicamente en su uso para pasar un socket UDP a ‚Äúmodo <em>broadcast</em>‚Äù. Para este caso particular, el par√°metro <code>level</code> debe contener la constante especial <code>SOL_SOCKET</code>, el par√°metro <code>option_name</code> la constante especial <code>SO_BROADCAST</code> y el valor de la opci√≥n igual a 1 (activar). La sintaxis de la funci√≥n en C exige que el valor final (el 1) se pase por referencia, junto con un par√°metro extra indicando la longitud en bytes de ese valor.</p>
<p>La versi√≥n python simplifica la sintaxis, y en este caso se usar√≠a as√≠:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># Asumiendo que s es un socket previamente creado para UDP</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>s.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, <span class="dv">1</span>)</span></code></pre></div>
<p>Una vez el socket est√° en ‚Äúmodo <em>broadcast</em>‚Äù su uso es id√©ntico al que ya conocemos. Usando <code>s.recvfrom()</code> se recibir√°n datagramas en el mismo (con la particularidad de que se reciben tambi√©n los de tipo <em>broadcast</em>), y usando <code>s.sendto()</code> se pueden enviar respuestas a nodos y puertos concretos.</p>
<h2 data-number="4.2" id="cliente" data-number="4.2"><span class="header-section-number">4.2</span> Cliente</h2>
<p>El cliente crea un socket UDP y da los siguientes pasos:</p>
<ol type="1">
<li>Env√≠a un datagrama por broadcast que contenga el mensaje ‚ÄúBUSCANDO HOLA‚Äù al puerto 12345 de todos los nodos de la subred.</li>
<li>Entra en un bucle ‚Äúinfinito‚Äù en el que repetidamente llama a <code>recvfrom()</code> para recibir posibles respuestas de servidores. Ya que no sabemos de antemano cu√°ntas podr√≠amos recibir (no sabemos cu√°ntos servidores habr√° activos en la subred para este servicio), la mejor estrategia es fijar un <em>timeout</em> para este <code>recvfrom()</code>. Cuando expire el <em>timeout</em> se asume que ya no hay m√°s servidores, y se sale del bucle ‚Äúinfinito‚Äù.</li>
<li>Para cada respuesta recibida, se muestra en pantalla la IP del servidor que ha respondido (como ya sabemos <code>recvfrom()</code> retorna tambi√©n la direcci√≥n origen del datagrama, por lo que podemos obtenerla ah√≠). Adem√°s, almacena en una variable la IP del primero que responda.</li>
<li>Si ha respondido al menos un servidor, probamos con √©l el servicio, enviando a ese servidor concreto (ya no por <em>broadcast</em>, sino a su IP concreta) un datagrama que contenga ‚ÄúHOLA‚Äù, y esperamos el datagrama de repuesta que mostramos por pantalla para finalizar.</li>
</ol>
<p>Observa que el paso 4 podr√≠a incluir tambi√©n <em>timeouts</em> y reintentos para tener en cuenta la posible p√©rdida de paquetes, pero no tendremos en cuenta este problema para simplificar la soluci√≥n.</p>
<p>Para enviar un datagrama por broadcast a toda una subred se hace en la forma siguiente:</p>
<ul>
<li><p>El socket debe tener activado el modo broadcast, lo cual se hace con <code>setsockopt()</code> (v√©ase el apartado sobre el servidor)</p></li>
<li><p>El datagrama se env√≠a a una IP especial que representa la subred. Esta direcci√≥n es la misma que la IP del cliente pero poniendo a 1 los bits que no son parte de la m√°scara de red. Por ejemplo, si nuestra IP es <code>192.168.0.17</code> y la m√°scara de red es <code>255.255.255.0</code>, la direcci√≥n de <em>broadcast</em> ser√° <code>192.168.0.255</code>.</p>
<p>En Linux puedes averiguar cu√°l es la direcci√≥n de <em>broadcast</em> usando la utilidad <code>ifconfig</code> (aparece en la segunda l√≠nea, con el nombre ‚ÄúDifus.‚Äù, por <em>difusi√≥n</em> que es la traducci√≥n de <em>broadcast</em>).</p>
<p>En Windows la utilidad <code>ipconfig</code> permite averiguar esta informaci√≥n, aunque de forma indirecta, a trav√©s de la ‚Äúm√°scara de subred‚Äù.</p></li>
</ul>
<div class="Alumno">
<p><strong>Ejercicio 6</strong></p>
<p>Implementa el servidor y el cliente descritos en los apartados anteriores, d√°ndoles los nombres <code>udp_servidor6_broadcast.py</code> y <code>udp_cliente6_broadcast.py</code>, respectivamente.</p>
<p>Prueba el cliente cuando haya varios servidores funcionando (de otros compa√±eros) y comprueba c√≥mo recibe varias respuestas.</p>
</div>
<h1 data-number="5" id="despliegue-con-docker" data-number="5"><span class="header-section-number">5</span> Despliegue con Docker</h1>
<h2 data-number="5.1" id="instalaci√≥n-de-docker" data-number="5.1"><span class="header-section-number">5.1</span> Instalaci√≥n de Docker</h2>
<p>Docker debe estar ya instalado desde la pr√°ctica inicial en que se cre√≥ la m√°quina virtual. Compru√©balo con <code>docker version</code>. Si no lo tienes instalado consulta el gui√≥n de aquella pr√°ctica para instrucciones.</p>
<h2 data-number="5.2" id="qu√©-es-docker" data-number="5.2"><span class="header-section-number">5.2</span> ¬øQu√© es docker?</h2>
<p>Docker es un conjunto de herramientas que simplifican enormemente el uso de los <em>contenedores linux</em> (una caracter√≠stica que tiene este operativo, ya desde hace tiempo y de forma independiente de docker).</p>
<p>Un contenedor puede ser conceptualizado como una especie de ‚Äúmini m√°quina virtual‚Äù. En realidad la tecnolog√≠a por debajo es completamente diferente. En una m√°quina virtual se usan instrucciones espec√≠ficas de virtualizaci√≥n del procesador y es necesario un hipervisor que gestione todo esto. La m√°quina virtual no tiene un operativo de por s√≠, y es necesario instalarle uno (como por ejemplo hemos hecho para instalar Ubuntu en VirtualBox). En los contenedores en cambio no es necesario ning√∫n hipervisor, no se instala ning√∫n operativo en ellos, sino que usan llamadas al operativo bajo el cual est√°n corriendo (linux en nuestro caso). Un contenedor es un conjunto de procesos Linux, pero ejecutados de tal forma (haciendo uso de <em>namespaces</em> linux) que no pueden ver nada fuera de su <em>sandbox</em>.</p>
<p>Al margen de los detalles de c√≥mo est√°n implementados, la forma m√°s simple de razonar sobre ellos es imaginar que son equivalentes a una m√°quina virtual, s√≥lo que mucho m√°s ligera, m√°s r√°pida de lanzar (no tiene un operativo que arrancar) y que consume menos recursos, sobre todo de disco y memoria (no tiene un disco virtual reservado para ella, no tiene una cantidad de RAM asignada que se quita del anfitri√≥n). En general, correr decenas de contenedores en un Linux es perfectamente posible.</p>
<p>Un concepto importante en Docker es el de <strong>imagen</strong>. Cuando un contenedor es lanzado, no tiene en principio acceso al sistema de archivos, sino que tiene su propio sistema de archivos interno. Por tanto tampoco podr√° acceder a las herramientas instaladas en el anfitri√≥n (por ejemplo <code>bash</code>, <code>python</code>, etc.), sino s√≥lo a las que est√©n accesibles en su propio sistema de archivos privado.</p>
<p>Una imagen es una plantilla (como si fuera una <em>clase</em> en POO), a partir de la cual se <em>instancia</em> (como si fuera un objeto en POO) el contenedor. La imagen proporciona un sistema de archivos con los ejecutables y herramientas que el contenedor podr√° usar durante su funcionamiento.</p>
<p>Las im√°genes son de s√≥lo lectura. Cuando el contenedor arranca, tendr√° visibles en su propio sistema de ficheros (que comienza en la carpeta ra√≠z <code>/</code>, pero que es indpendiente de lo que haya en esa carpeta en el anfitri√≥n). Puede leer de ese sistema de archivos (para cargar programas, datos, etc.) pero si intenta escribir algo, se crear√° una nueva ‚Äúcapa‚Äù en el sistema de archivos y ser√° en esa capa extra donde se realizan las modificaciones. Conceptualmente es similar a un sistema de capas como el que tienen los programas de edici√≥n gr√°fica tipo Photoshop. Cada capa tiene zonas ‚Äútransparentes‚Äù a trav√©s de las cuales son visibles las capas inferiores. En el caso de docker eso significa que cuando un proceso dentro del contenedor intenta acceder a un fichero, se busca el mismo en la capa superior y si no est√°, se sigue buscando en capas inferiores. S√≥lo la capa superior se puede escribir.</p>
<p>Cuando el contenedor termina su ejecuci√≥n, t√≠picamente la capa superior en la que ha escrito cosas se descarta (aunque podr√≠a guardarse como ya veremos). La consecuencia es que se pierde todo lo que el contenedor haya escrito, y la ventaja es que instanciar un nuevo contenedor nos garantiza que comienza otra vez ‚Äúde cero‚Äù, de la misma imagen, que no pudo ser modificada por otras ejecuciones anteriores.</p>
<p>Adem√°s de tener su propio sistema de archivos independiente del del anfitri√≥n, un contenedor tambi√©n tiene su propia <strong>red</strong>, con su IP y los puertos que est√©n usando las aplicaciones que corren dentro del contenedor. Esto implica que podemos lanzar la misma aplicaci√≥n varias veces en diferentes contenedores, sin tener que cambiar el puerto en que escucha cada una, pues cada contenedor es una IP diferente y por tanto no hay choque de puertos.</p>
<h2 data-number="5.3" id="primer-ejemplo" data-number="5.3"><span class="header-section-number">5.3</span> Primer ejemplo</h2>
<p>Para lanzar un contenedor el comando es <code>docker run</code>, y a √©l hay que pasarle el nombre de la imagen que queremos lanzar. M√°s adelante crearemos nuestras propias im√°genes, pero docker puede usar tambi√©n un <strong>repositorio p√∫blico</strong> de im√°genes al cual acceder√° si la imagen que le pedimos lanzar no la encuentra en el repositorio local.</p>
<p>Veamos qu√© im√°genes tenemos instaladas:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a>$ <span class="ex">docker</span> images</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="ex">REPOSITORY</span>          TAG                 IMAGE ID            CREATED             SIZE</span></code></pre></div>
<p>Por la respuesta vemos que no tenemos ninguna imagen descargada. Descarguemos una que contenga la √∫ltima versi√≥n de python, recientemente aparecida y que a√∫n no est√° disponible en Ubuntu. Se trata de python 3.7:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a>$ <span class="ex">docker</span> pull python:3.7</span>
<span id="cb14-2"><a href="#cb14-2"></a>[<span class="ex">...</span> descarga varias capas de im√°genes, tarda un rato ...]</span>
<span id="cb14-3"><a href="#cb14-3"></a>$ <span class="ex">docker</span> images</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="ex">REPOSITORY</span>          TAG                 IMAGE ID            CREATED             SIZE</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="ex">python</span>              3.7                 638817465c7d        8 days ago          922MB</span></code></pre></div>
<p>¬øQu√© ha ocurrido? Docker se ha conectado con su repositorio, ha encontrado la imagen llamada <code>python</code> con el tag <code>3.7</code> y la ha descargado. La imagen se compone de varias capas, en la primera por ejemplo t√≠picamente est√°n herramientas de l√≠nea de comandos t√≠picas de Ubuntu, sobre ellas se instalan herramientas de desarrollo, compiladores C (por si hacen falta en python), etc. Finalmente se instala python y sus bibliotecas. El hacerlo por capas favorece la reutilizaci√≥n. Si, por ejemplo, queremos ahora la versi√≥n 3.6, ver√°s que muchas de las capas necesarias ya han sido descargadas por tanto no s√≥lo se acelera la descarga en este segundo caso, sino que adem√°s se reduce el uso del disco en el anfitri√≥n:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a>$ <span class="ex">docker</span> pull python:3.6</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="bu">[</span> ... muchas de las capas necesarias ya estaban descargdas, es m√°s r√°pido ...]</span>
<span id="cb15-3"><a href="#cb15-3"></a>$ docker images</span>
<span id="cb15-4"><a href="#cb15-4"></a>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span>
<span id="cb15-5"><a href="#cb15-5"></a>python              3.6                 d49c41b6e6c4        8 days ago          918MB</span>
<span id="cb15-6"><a href="#cb15-6"></a>python              3.7                 638817465c7d        8 days ago          922MB</span></code></pre></div>
<p>Tenemos dos im√°genes, y aunque se nos reporta que el tama√±o de cada una es de unos 900MB, esto no implica que estemos ocupando 1800MB en total, ya que las im√°genes tienen grandes partes en com√∫n.</p>
<p>Lancemos el contenedor para probar. La forma de lanzarlo es <code>docker run &lt;nombre de la imagen&gt;</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a>$ <span class="ex">docker</span> run python:3.7</span></code></pre></div>
<p>No ha pasado nada? Veamos si tenemos contenedores en ejecuci√≥n:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a>$ <span class="ex">docker</span> ps</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ex">CONTAINER</span> ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span></code></pre></div>
<p>La lista est√° vac√≠a. No hay contenedores en ejecuci√≥n. Pero probemos la opci√≥n <code>-a</code> (<em>all</em>) que nos muestra tambi√©n los contenedores que han muerto:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a>$ <span class="ex">docker</span> ps -a </span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="ex">CONTAINER</span> ID        IMAGE               COMMAND             CREATED              STATUS                          PORTS               NAMES</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="ex">66c93f7b909e</span>        python:3.7          <span class="st">&quot;python3&quot;</span>           About a minute ago   Exited (0) <span class="ex">About</span> a minute ago                       clever_mclean</span></code></pre></div>
<p>Aj√°. Aqu√≠ vemos el contenedor que acab√°bamos de lanzar. Podemos ver su ID (que es un hash), que podemos usar para referirnos a √©l, la imagen desde la que ha sido instanciado (<code>python:3.7</code>) y el comando que ejecut√≥ (<code>python3</code>). El nombre <code>clever_mclean</code>, que en tu caso ser√° diferente, es un nombre aleatorio que docker le pone al contenedor, para que sea m√°s f√°cil de recordar y teclear que su ID hexadecimal. Tambi√©n podr√≠amos haber especificado nosotros otro nombre con la opci√≥n <code>-n</code>.</p>
<p>Entonces el contenedor se ejecut√≥, lanz√≥ dentro el comando <code>python3</code>, y cuando este comando termin√≥, el contenedor se termin√≥. Sigue estando disponible en la lista de <code>docker ps -a</code> por si quisi√©ramos guardar los cambios que ese contenedor haya podido hacer en la capa de escritura. Si queremos descartar esos posibles cambios, hay que borrar el contenedor con:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a>$ <span class="ex">docker</span> rm clever_mclean <span class="co"># Usa el nombre de tu contenedor</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>$ <span class="ex">docker</span> ps -a</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="ex">CONTAINER</span> ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span></code></pre></div>
<p>De momento no parece muy √∫til, pues aunque hemos ejecutado python3 dentro del contenedor, no hemos podido pasarle un archivo <code>.py</code> para que lo ejecute.</p>
<p>Escribe lo siguiente en un fichero llamado <code>prueba.py</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="im">import</span> sys</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="bu">print</span>(<span class="st">&quot;Me estoy ejecutando con Python&quot;</span>, sys.version)</span></code></pre></div>
<p>Prueba a ejecutarlo, sin contenedores, con el python que tienes instalado en Ubuntu:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a>$ <span class="ex">python3</span> prueba.py</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="ex">Me</span> estoy ejecutando con Python 3.6.5 (default, Apr  1 2018, 05:46:30)</span>
<span id="cb21-3"><a href="#cb21-3"></a>[<span class="ex">GCC</span> 7.3.0]</span></code></pre></div>
<p>Podemos ver la versi√≥n 3.6.5. Ahora probemos a ejecutarlo con la versi√≥n 3.7 v√≠a docker:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a>$ <span class="ex">docker</span> run python:3.7 python prueba.py</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="kw">(</span><span class="ex">null</span><span class="kw">)</span><span class="bu">:</span> can<span class="st">&#39;t open file &#39;</span>prueba.py<span class="st">&#39;: [Errno 2] No such file or directory</span></span></code></pre></div>
<p>No ha funcionado. ¬øQu√© ha ocurrido? Como explicamos en la introducci√≥n, el contenedor tiene su propio sistema de ficheros y no puede ver el del anfitri√≥n, por lo que <code>prueba.py</code> no est√° disponible.</p>
<p>As√≠ las cosas no parece muy √∫til. ¬øC√≥mo hacer visible <code>prueba.py</code> para el contenedor? Tenemos dos enfoques:</p>
<ol type="1">
<li>Crear una imagen nueva que incluya <code>prueba.py</code>. Esta ser√≠a la opci√≥n correcta si queremos distribuir nuestro software v√≠a docker. Crear√≠amos esta imagen (para lo que es necesario escribir un <code>Dockerfile</code>) le dar√≠amos un nombre, y una vez creada podremos subirla al repositorio p√∫blico de Docker (habr√≠a que abrir una cuenta gratu√≠ta). Una vez all√≠ cualquier otra persona con conexi√≥n a internet podr√≠a hacer <code>docker pull &lt;nombre de nuestra imagen&gt;</code> y obtener una copia local para lanzarla con <code>docker run</code>.</li>
<li>Durante el desarrollo todo lo anterior es demasiada complicaci√≥n. Lo que suele hacerse en cambio es ‚Äúmontar‚Äù la carpeta del anfitri√≥n donde est√° el archivo que queremos acceder, en una carpeta dentro del contenedor.</li>
</ol>
<p>Veamos la segunda opci√≥n. Pas√°ndole a <code>docker run</code> la opci√≥n <code>-v /ruta/a/carpeta/local:/ruta/a/carpeta/en/contenedor</code> tendr√≠amos que, una vez dentro del contenedor, los contenidos de la carpeta <code>/ruta/a/carpeta/en/contenedor</code> ser√≠an los de la carpeta <code>/ruta/a/carpeta/local/</code> del anfitri√≥n. De hecho no es una mera copia, <em>es la misma carpeta</em>. Si el contenedor escribe algo o borra ficheros, estos cambios suceder√°n tambi√©n en la carpeta del anftri√≥n. Por tanto es una buena opci√≥n para compartir informaci√≥n entre el anfitri√≥n y el contenedor y viceversa, pero debemos confiar en lo que se est√© ejecutando en el contenedor. De todas formas, lo que el contenedor pueda hacer sobre el sistema de archivos del anfitri√≥n est√° limitado a esa carpeta solamente.</p>
<p>As√≠ pues, podemos usar <code>$(pwd)</code> para obtener cu√°l es la carpeta actual, y montarla en la ruta <code>/app</code>, por ejemplo, del contenedor, con lo que har√≠amos:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a>$ <span class="ex">docker</span> run -v <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app python:3.7 python /app/prueba.py</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="ex">Me</span> estoy ejecutando con Python 3.7.0 (default, Jul 17 2018, 11:04:33)</span>
<span id="cb23-3"><a href="#cb23-3"></a>[<span class="ex">GCC</span> 6.3.0 20170516]</span></code></pre></div>
<p>Vemos que ha funcionado, y podemos verificar que la versi√≥n que lo est√° ejecutando es la del contenedor, pues es la <code>3.7.0</code>.</p>
<div class="Cuestion">
<p>Prueba a lanzar el mismo programa con la imagen docker <code>python:3.6</code> ¬øUsa la misma versi√≥n de python que el <code>python3</code> que tienes instalado en Ubuntu?</p>
</div>
<p>Para terminar con el experimento, puede resultarte √∫til saber que puedes lanzar cualquier otro de los comandos contenidos en la imagen (por ejemplo, la imagen que hemos descargado de python tambi√©n contiene <code>bash</code>, <code>pip</code> y otras muchas herramientas). Probemos a lanzar <code>bash</code>, para lo cual necesitamos que la sesi√≥n sea interactiva y tenga asociada una terminal, lo que se logra con las opciones <code>-i</code>, <code>-t</code>. Por tanto:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a>$ <span class="ex">docker</span> run -i -t python:3.7 bash</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="ex">root@0b0118936495</span>:/#</span></code></pre></div>
<p>El prompt que obtenemos nos muestra que somos el usuario <code>root</code> dentro del contenedor. Puedes intentar lanzar diferentes comandos. Se buscar√°n en el sistema de archivos del contenedor, no del anfitri√≥n. De hecho estamos en una <em>sandbox</em> y no podemos acceder a los ficheros del anfitri√≥n.</p>
<p>Intenta los siguientes comandos, mientras est√°s en el contenedor:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># python --version</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="ex">Python</span> 3.7.0</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co"># which python3</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="ex">/usr/local/bin/python</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co"># rm /usr/local/bin/python</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co"># python --version</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="ex">bash</span>: /usr/local/bin/python: No such file or directory</span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="co"># exit</span></span></code></pre></div>
<p>¬øQu√© hemos hecho? Hemos visto que est√°bamos en el contenedor pues la versi√≥n de python era la 3.7. Hemos averiguado d√≥nde estaba instalado python y ¬°lo hemos borrado! Despu√©s, con <code>exit</code>, finalizamos el comando <code>bash</code> y ya que √©ste era el √∫nico proceso del contenedor, el contenedor muere.</p>
<p>No pasa nada, esos cambios se han hecho en la √∫ltima capa del contenedor, la que se descarta y no tiene influencia en la imagen. Si lanzas el contenedor de nuevo ver√°s que python vuelve a estar ah√≠ (hazlo).</p>
<div class="Cuestion">
<p>Como consecuencia de los experimentos anteriores tendremos varios contenedores muertos, que puedes ver con <code>docker ps -a</code>. Puedes eliminarlos todos con:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a>$ <span class="ex">docker</span> container prune</span></code></pre></div>
</div>
<h2 data-number="5.4" id="lanzar-el-servidor-udp-en-un-contenedor" data-number="5.4"><span class="header-section-number">5.4</span> Lanzar el servidor UDP en un contenedor</h2>
<p>Tras los ejemplos anteriores parece que para lanzar uno de los servidores UDP que hemos desarrollado en esta pr√°ctica, por ejemplo el <code>udp_servidor3_con_ok.py</code> bastar√≠a colocarnos en la carpeta en la que est√° ese ejercicio y hacer como en el caso de <code>prueba.py</code>. En este caso, sin embargo, ya que el contenedor no terminar√° nunca pues es un servidor, interesar√° poner adem√°s la opci√≥n <code>-d</code> (de <em>daemon</em>), que causa que el contenedor completo se ejecute en <em>background</em> y desconectado de la terminal (no veremos lo que imprime el script):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a>$ <span class="ex">docker</span> run -d -v <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app python:3.7 python /app/udp_servidor3_con_ok.py</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="ex">8e77ad5788d17341027ccab14f33af15df620442db6ae834971368c81544680e</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>$ <span class="ex">docker</span> ps</span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="ex">CONTAINER</span> ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES</span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="ex">8e77ad5788d1</span>        python:3.7          <span class="st">&quot;python /app/udp_s...&quot;</span>   About a minute ago   Up About a minute                       frosty_lumiere</span></code></pre></div>
<p>Vemos que esta vez est√° en ejecuci√≥n (no hemos usado <code>-a</code> con <code>docker ps</code>). ¬øQu√© estar√° haciendo? Podemos conectarnos a un contenedor en ejecuci√≥n, mediante el comando <code>exec</code> para ejecutar otro comando m√°s dentro del mismo contenedor. Por ejemplo, ejecutemos <code>bash</code> en ese mismo contenedor. Ser√° necesario las opciones <code>-i</code>, <code>-t</code> (que puede abreviarse a <code>-it</code>) para tener la sesi√≥n interactiva. Una vez dentro del contenedor podemos hacer <code>ps</code> (el comando linux) para ver qu√© est√° ejecutando:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1"></a>$ <span class="ex">docker</span> exec -it frosty_lumiere bash</span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="ex">root@8e77ad5788d1</span>:/# ps aux</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="ex">USER</span>       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="ex">root</span>         1  0.0  1.2  51128 12580 ?        Ss   15:32   0:00 python /app/udp_servidor3_con_ok.py</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="ex">root</span>         5  0.1  0.3  19956  3732 pts/0    Ss   15:38   0:00 bash</span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="ex">root</span>        12  0.0  0.3  38388  3124 pts/0    R+   15:39   0:00 ps aux</span></code></pre></div>
<p>Vemos que tan s√≥lo hay tres procesos dentro del contenedor. Y dos de ellos son los que acabamos de lanzar (el comando <code>bash</code> y dentro de √©l, <code>ps</code>).</p>
<p>Por tanto el sevidor est√° funcionando y estar√° esperando conexiones en el puerto 9999 (puerto por defecto). ¬øC√≥mo conectar un cliente con √©l para comprobarlo? El problema es que el contenedor est√° en su propia sub-red privada y tiene su propia IP.</p>
<p>Podemos averiguar cu√°l es esa IP con el comando siguiente:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a>$ <span class="ex">docker</span> inspect frosty_lumiere</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="bu">[</span> ... montones de informaci√≥n ... filtremos solo su IP ...]</span>
<span id="cb29-3"><a href="#cb29-3"></a>$ docker inspect frosty_lumiere|grep IPAddress</span>
<span id="cb29-4"><a href="#cb29-4"></a>            <span class="st">&quot;SecondaryIPAddresses&quot;</span>: null,</span>
<span id="cb29-5"><a href="#cb29-5"></a>            <span class="st">&quot;IPAddress&quot;</span>: <span class="st">&quot;172.17.0.2&quot;</span>,</span>
<span id="cb29-6"><a href="#cb29-6"></a>                    <span class="st">&quot;IPAddress&quot;</span>: <span class="st">&quot;172.17.0.2&quot;</span>,</span></code></pre></div>
<p>Una vez averiguado, probemos a conectar un cliente lanzado desde el anfitri√≥n:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1"></a>$ <span class="ex">python3</span> udp_cliente4_reintenta.py 172.17.0.2 9999</span></code></pre></div>
<p>y deber√≠a funcionar. ¬øY si intentamos lanzar el cliente en otro contenedor? La sintaxis ser√≠a la siguiente:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a>$ <span class="ex">docker</span> run -it -v <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app python:3.7 \</span>
<span id="cb31-2"><a href="#cb31-2"></a>   python /app/udp_cliente4_reintenta.py 172.17.0.2 9999</span></code></pre></div>
<p>¬°Y vemos que tambi√©n funciona!</p>
<h3 data-number="5.4.1" id="subredes-y-nombres" data-number="5.4.1"><span class="header-section-number">5.4.1</span> Subredes y nombres</h3>
<p>Lo que ocurre es que docker crea una sub-red privada en la que lanza por defecto todos los contenedores. Por tanto los contenedores pueden comunicarse unos con otros si conocen sus IPs. Adem√°s, en el nodo anfitri√≥n ha creado una interfaz de red virtual que act√∫e como puente con la subred interna. Puedes verla si haces <code>ifconfig</code> (se llama <code>docker</code>), lo que explica por qu√© tambi√©n desde el anfitri√≥n pudimos comunicarnos con el servidor a trav√©s de su IP.</p>
<p>Sin embargo, desde fuera del anfitri√≥n no ser√≠a posible comunicarse con este servidor. Por ejemplo, desde tu m√°quina Windows o desde la de tu compa√±ero. Desde otras m√°quinas, la IP <code>172.17.0.2</code> no es accesible. Si quisieras que desde fuera se pudiera conectar con tu servidor, deber√≠as ‚Äúpublicar‚Äù su puerto en otro puerto del anfitri√≥n, con la opci√≥n <code>-P</code> de <code>docker run</code>. M√°s adelante usaremos esto tambi√©n, pero de momento no hace falta.</p>
<p>Para terminar vamos a lanzar de nuevo cliente y servidor, pero esta vez d√°ndoles unos nombres y dentro de una subred creada expresamente por nosotros, en lugar de usar la subred por defecto. Cuando hacemos esto, docker pone en marcha de forma transparente un servidor DNS de modo que ya no necesitamos conocer las IPs de los contenedores, sino que podemos referirnos a ellos por su nombre.</p>
<div class="Alumno">
<ol type="1">
<li><p>Primero aseg√∫rate de que no tienes corriendo ning√∫n contenedor con <code>docker ps</code>. Si a√∫n est√° el servidor del apartado anterior puedes matarlo con <code>docker stop nombre_del_contenedor</code> (no confundas el nombre del contenedor con el de su imagen). Quiz√°s tarde un poco. Docker env√≠a la se√±al SIGTERM a los procesos dentro del contenedor para darles la opci√≥n de terminar de forma amistosa. Si lo ignoran (como es el caso), unos segundos m√°s tarde los termina ‚Äúpor las malas‚Äù (SIGKILL).</p></li>
<li><p>Limpia los contenedores que hayan quedado detenidos con <code>docker container prune</code></p></li>
<li><p>Crea una nueva subred para lanzar contenedores en ella. Esto se logra con <code>docker network create</code>. Le daremos el nombre <code>pruebas</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a>$ <span class="ex">docker</span> network create pruebas</span></code></pre></div></li>
<li><p>Lanza el servidor dentro de esa subred, con el siguiente comando que a la vez le da un nombre (<code>servidor</code>) al contenedor:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="ex">docker</span> run -d --name servidor --network pruebas\</span>
<span id="cb33-2"><a href="#cb33-2"></a>  -v <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app python:3.7 python /app/udp_servidor3_con_ok.py</span></code></pre></div></li>
</ol>
</div>
<p>Como consecuencia de haber creado una nueva subred, <code>ifconfig</code> en el anfitri√≥n mostrar√° ahora una nueva interfaz virtual (en mi caso con la IP <code>172.18.0.1</code>, en tu caso puede cambiar), que serviria al anfitri√≥n para conectar con los contenedores que haya dentro, por su IP.</p>
<p>Pero si lanzamos m√°s contenedores dentro de esa misma subred, cada contenedor no necesita conocer las IPs de los restantes, pues puede acceder a ellos por sus nombres, que son los que hayamos dado en la opci√≥n <code>--name</code>.</p>
<p>Comprob√©moslo. Para ello vamos a utilizar el comando <code>ping</code> que no est√° instalado por defecto en la imagen docker, por lo que hay que instalarlo el paquete <code>iputils-ping</code> antes de usarlo.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="ex">docker</span> run -it --name test --network pruebas python:3.7 bash</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="ex">root@ea6f554d7422</span>:/# apt-get update</span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="ex">root@ea6f554d7422</span>:/# apt-get install iputils-ping</span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="ex">root@ea6f554d7422</span>:/# ping servidor</span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="ex">PING</span> servidor (172.18.0.2) <span class="ex">56</span>(84) <span class="ex">bytes</span> of data.</span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="ex">64</span> bytes from servidor.pruebas (172.18.0.2)<span class="bu">:</span> icmp_seq=1 ttl=64 time=0.053 ms</span></code></pre></div>
<p>Por tanto ahora podemos lanzar nuestro cliente as√≠:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a><span class="ex">docker</span> run -it --network pruebas --name cliente -v <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app python:3.7 \</span>
<span id="cb35-2"><a href="#cb35-2"></a>   python /app/udp_cliente4_reintenta.py servidor 9999</span></code></pre></div>
<div class="Cuestion">
<p>Prueba los comandos anteriores. Aseg√∫rate de que entiendes todas las opciones y lo que est√° pasando. Pregunta a tu profesor si tienes alguna duda</p>
</div>
<h2 data-number="5.5" id="lanzar-el-ejemplo-broadcast" data-number="5.5"><span class="header-section-number">5.5</span> Lanzar el ejemplo broadcast</h2>
<div class="Alumno">
<p><strong>Ejercicio 7</strong></p>
<p>En la subred <code>pruebas</code> antes creada lanza tres contenedores que ejecuten <code>udp_servidor6_broadcast.py</code>. Dale un nombre diferente a cada uno, o no des nombre para que docker elija uno al azar (en este caso el nombre no importa porque el cliente no va a usarlo). Verifica que est√°n todos en ejecuci√≥n con <code>docker ps</code>.</p>
<p>Averigua la direcci√≥n de broadcast de esta subred, entrando en uno de esos contenedores y ejecutando <code>ip addr</code> (este comando no est√° instalado por defecto, por lo que debes instalar antes el paquete <code>iproute2</code> dentro del contenedor en marcha). Ah√≠ podr√°s ver la IP de la interfaz, en su notaci√≥n CIDR, por ejemplo <code>172.18.0.2/16</code> que indica que de la IP dada, los 16 primeros bits son la parte de red. Esto nos permite deducir la IP de broadcast.</p>
<p>Alternativamente esta informaci√≥n puede obtenerse desde fuera del contenedor y por tanto sin tener que instalar nada en √©l, ejecutando <code>docker inspect &lt;nombre_del_contenedor&gt;</code> y observando las variables <code>IPAddress</code> e <code>IPPrefixLen</code> que mostrar√≠an en este caso <code>172.18.0.2</code> y <code>16</code> respectivamente. Compru√©balo.</p>
<p>Lanza ahora el cliente <code>udp_cliente6_broadcast.py</code> usando como IP de broadcast la que has averiguado.</p>
<p>Comprueba que los tres servidores responden y que el cliente elige al primero de ellos para enviarle la petici√≥n. ¬øCu√°l es la IP del cliente? (m√≠rala en la respuesta del servidor).</p>
<p>Guarda en dos ficheros los scripts shell necesarios para lanzar a todos los servidores (<code>udp_docker_lanzar_servidores.sh</code>) y el que lanza al cliente (<code>udp_docker_lanzar_cliente.sh</code>).</p>
</div>
</div>
</article>
</div>
</div>
</body>
</html>
